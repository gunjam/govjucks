#!/usr/bin/env node
'use strict';

const { parseArgs } = require('node:util');
const precompile = require('../src/precompile').precompile;
const Environment = require('../src/environment').Environment;

/** @type {import('node:util').ParseArgsOptionsConfig} */
const options = {
  force: {
    type: "boolean",
    short: "f",
  },
  filters: {
    type: "string",
    short: "a",
  },
  name: {
    type: 'string',
    short: "n",
  },
  include: {
    type: 'string',
    short: "i",
    default: ['\\\\.html$', '\\\\.jinja$'],
    multiple: true,
  },
  exclude: {
    type: 'string',
    short: "x",
    default: [],
    multiple: true,
  },
  wrapper: {
    type: 'string',
    short: "w",
  },
  help: {
    type: 'boolean',
    short: "h",
  },
};

const helpMessage = `Usage: precompile [-f|--force] [-a|--filters <filters>] [-n|--name <name>] [-i|--include <regex>] [-x|--exclude <regex>] [-w|--wrapper <wrapper>] <path>

Options:
  -f, --force              Force compilation to continue on error
  -a, --filters <filters>  Give the compiler a comma-delimited list of asynchronous filters, required for correctly
                           generating code
  -n, --name <name>        Specify the template name when compiling a single file
  -i, --include <regex>    Include a file or folder which match the regex but would otherwise be excluded. You can use
                           this flag multiple times (default: ["\\\\.html$","\\\\.jinja$"])
  -x, --exclude <regex>    Exclude a file or folder which match the regex but would otherwise be included. You can use
                           this flag multiple times (default: [])
  -w, --wrapper <wrapper>  Load a external plugin to change the output format of the precompiled templates (for example,
                           "-w custom" will load a module named "govjucks-custom")
  --h, --help              Display this help message`;

const { values, positionals } = parseArgs({ options, allowPositionals: true });

if (values.help || values.holp) {
  console.log(helpMessage);
  process.exit(0);
}

if (positionals.length === 0) {
  console.log(helpMessage);
  console.error('\nerror: no path given');
  process.exit(1);
}

const env = new Environment([]);

if (values.filters) {
  for (const filter of values.filters.split(',')) {
    env.addFilter(filter.trim(), function () {}, true);
  }
}

if (values.wrapper) {
  values.wrapper = require('govjucks-' + opts.wrapper).wrapper;
}

console.log(precompile(positionals[0], {
  env : env,
  force : values.force,
  name : values.name,
  wrapper: values.wrapper,
  include : values.include,
  exclude : values.exclude,
}));
